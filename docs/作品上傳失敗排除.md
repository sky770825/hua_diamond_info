# 作品圖片上傳失敗排除

## 後台改動（已做）

- 上傳時帶入 **contentType**（`file.type` 或 image/jpeg），避免 Storage 拒收。
- 新增作品時帶入 **sort_order: 0**（若表有該欄位且必填可避免錯誤）。
- 錯誤訊息改為「作品圖片上傳失敗：…」／「新增作品紀錄失敗：…」，方便判斷是 **Storage** 還是 **資料表** 出錯。

---

## 常見原因與處理

### 1. Storage RLS 未允許 `portfolio` 資料夾

若錯誤是 **「作品圖片上傳失敗：…」** 且訊息含 `policy`、`row-level security`、`access denied` 等，多半是 Storage 的 RLS 只允許 `avatars`，沒允許 `portfolio`。

**處理：** 在 Supabase Dashboard → **Storage** → 選 bucket `hua-diamond-images` → **Policies**，新增一筆 **INSERT** 政策，讓 anon 可上傳到 `portfolio`：

- **Policy name**：`Allow anon upload portfolio`
- **Allowed operation**：INSERT
- **Target roles**：anon（或 public）
- **Policy definition**（依需求二選一）：

  **A. 只允許 portfolio 資料夾：**
  ```sql
  (bucket_id = 'hua-diamond-images') AND ((storage.foldername(name))[1] = 'portfolio')
  ```

  **B. 允許 avatars 與 portfolio（與現有 avatars 政策類似）：**
  ```sql
  (bucket_id = 'hua-diamond-images') AND (
    (storage.foldername(name))[1] = 'avatars' OR
    (storage.foldername(name))[1] = 'portfolio'
  )
  ```

存檔後再試一次「新增作品」上傳。

---

### 2. 資料表沒有 `sort_order` 欄位

若錯誤是 **「新增作品紀錄失敗：…」** 且訊息含 `column "sort_order" does not exist`，代表 `hua_member_portfolios` 沒有 `sort_order`。

**處理：**

- **選項 A**：在 Supabase **SQL Editor** 加欄位（有預設值即可）：
  ```sql
  ALTER TABLE public.hua_member_portfolios
  ADD COLUMN IF NOT EXISTS sort_order integer NOT NULL DEFAULT 0;
  ```
- **選項 B**：若不想加欄位，可請開發從後台程式移除對 `sort_order` 的寫入（需改 `admin-full.html` 的 insert 欄位）。

---

### 3. 檔案過大或格式被拒

若錯誤與 **file size**、**content type** 有關：

- 檢查 Supabase Storage 該 bucket 的 **File size limit**（預設可能 50MB）。
- 確認上傳的是圖片（如 jpeg/png），且後台有帶 `contentType`（目前程式已帶入）。

---

### 4. 仍失敗時請看完整錯誤

後台畫面上的錯誤區塊會顯示「作品圖片上傳失敗：…」或「新增作品紀錄失敗：…」後面的完整訊息。把那段完整錯誤貼給開發或對照 Supabase 文件即可進一步排查。
