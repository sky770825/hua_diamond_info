# 修復紀錄｜生產環境載入失敗（2026-02-01）

## 〇、問題發生時機

| 階段 | 時間點 | 狀況 |
|------|--------|------|
| 專案建立 | 之前 | 前端、後端、開發 proxy 都正常 |
| 開發環境 | 之前 | `npm run dev` + 後端，一切正常 |
| 部署到 Cloudflare Pages | **首次上線後** | 前端靜態檔部署成功，但 API 請求失敗 |
| 問題浮現 | 使用者開啟生產網址 | 畫面顯示「載入失敗」 |

**結論**：問題出現在**將前端部署到純靜態主機（Cloudflare Pages）時**，因為該主機沒有後端 API，與開發環境的架構不同，卻沿用相同的 API 路徑邏輯（同網域 `/api`）。

---

## 一、現象

部署至 **https://hua-diamond-info.pages.dev** 後，網頁顯示異常：

- 頁面標題「資訊組｜成員牆」正常顯示
- 主內容區域顯示「載入失敗」
- 錯誤訊息：`Unexpected token '<', "<!doctype "... is not valid JSON`
- 提示：請確認後端 API 已啟動（預設 http://localhost:3001）

---

## 二、原因分析

### 2.1 資料載入流程

前端透過 `fetchMembers()` 取得成員資料，會呼叫 `/api/members`（或加上 `VITE_API_URL` 後端網址）。

| 環境 | VITE_API_URL | 實際請求路徑 |
|------|--------------|--------------|
| 開發 | 留空 | `/api/members` → Vite proxy 轉到 localhost:3001 |
| 生產（有後端） | 已設定 | `https://後端網址/api/members` |
| 生產（無後端） | 未設定 | `/api/members`（同網域） |

### 2.2 問題根因

**Cloudflare Pages 僅提供靜態檔案**，沒有後端 API，因此：

1. 生產環境未設定 `VITE_API_URL`，前端請求同網域的 `/api/members`
2. Cloudflare Pages 上沒有 `/api` 路徑
3. `_redirects` 規則為 `/* /index.html 200`，所有未命中路徑都會回傳 index.html
4. 結果：`/api/members` 回傳的是 **HTML**（`<!doctype html>...`），不是 **JSON**
5. 前端執行 `res.json()` 時無法解析 HTML → 拋出 `Unexpected token '<', "<!doctype "... is not valid JSON`
6. 畫面顯示「載入失敗」

---

## 三、修復方式

### 3.1 解決方案

在**生產環境且未設定 `VITE_API_URL`** 時，改為讀取靜態 JSON 檔 `/members.json`，不再請求 `/api/members`。

### 3.2 修改內容

| 檔案 | 變更 |
|------|------|
| `public/members.json` | 新增。從 `backend/data/members.json` 複製成員資料，作為靜態 fallback |
| `src/api/client.ts` | 修改。當 `import.meta.env.PROD` 且 `VITE_API_URL` 為空時，`apiUrl("api/members")` 回傳 `/members.json` 而非 `/api/members` |

### 3.3 修改後邏輯

```
生產環境 + 未設定 VITE_API_URL
  → apiUrl("api/members") 回傳 "/members.json"
  → fetch("/members.json") 取得靜態 JSON
  → 頁面正常顯示成員牆

開發環境
  → 仍使用 /api/members（Vite proxy → 本機後端）

生產環境 + 已設定 VITE_API_URL
  → 仍使用後端 API 網址
  → 取得即時動態資料
```

---

## 四、部署方式

修復後透過以下指令完成部署：

```bash
npm run deploy
```

等同於：

1. `npm run build`（產出 dist/，含 members.json）
2. `npx wrangler pages deploy dist --project-name=hua-diamond-info`

---

## 五、後續建議

### 若日後要接後端 API（如 Zeabur）

1. 將後端部署至可公開存取的網址
2. 在 **Cloudflare Pages** 專案設定環境變數：
   - `VITE_API_URL` = `https://你的後端網址`（不要加結尾 `/`）
3. 重新建置 / 部署後，前端會改為呼叫後端 API，取得即時資料

### 若維持純靜態（無後端）

- 需更新成員資料時，修改 `public/members.json` 後重新 `npm run deploy`
- 或透過 GitHub push，由 Cloudflare Git 整合自動建置與部署

---

## 六、相關檔案

- `src/api/client.ts`：API 網址邏輯
- `src/api/members.ts`：成員資料取得
- `src/hooks/useMembers.ts`：成員資料狀態管理
- `public/members.json`：靜態成員資料（fallback）
- `public/_redirects`：SPA 路由回退規則

---

## 七、新建專案／設計時優先注意事項

以下為**新建專案或做設計時**應優先納入的檢查項目，避免類似問題。

### 7.1 架構釐清（專案初期）

| 項目 | 問題 | 建議 |
|------|------|------|
| 生產環境主機類型 | 前端會部署到哪裡？靜態主機（Pages、Vercel、Netlify）還是 SSR 主機？ | 一開始就要釐清：**生產環境有沒有後端 API** |
| API 來源 | 生產環境的 API 在哪？同網域、不同網域、或根本沒有？ | 若為純靜態主機，需事先規劃：靜態資料、CDN、或外接 API |
| 環境變數 | `VITE_API_URL`（或等同變數）是否在建置時就會設定？ | 建置時注入，生產與開發路徑會不同 |

### 7.2 API 設計（開發階段）

| 項目 | 問題 | 建議 |
|------|------|------|
| 開發 vs 生產 | 開發用 proxy（如 `/api` → localhost），生產用什麼？ | 用環境變數區分，例如：`VITE_API_URL` 有值 = 後端；無值 = 靜態或 fallback |
| 無後端情境 | 生產環境若沒有後端，API 請求會打到哪裡？ | 事先定義：靜態 JSON、CDN JSON、或錯誤處理與 fallback |
| SPA 規則 | `_redirects` 或 `vercel.json` 的 SPA 規則會不會影響 `/api/*`？ | 若 `/api` 不存在，會被導到 index.html，導致 JSON 變成 HTML |

### 7.3 部署前檢查清單

| 檢查項目 | 說明 |
|----------|------|
| [ ] 生產主機是靜態還是 SSR？ | 靜態：不會有 `/api`，需外接或使用靜態資料 |
| [ ] `VITE_API_URL` 是否在建置／部署流程中設定？ | 有後端：必須設定；無後端：要改為靜態或 fallback |
| [ ] 生產環境首次部署後，是否驗證 API 請求？ | 開啟 DevTools → Network，確認 `/api/*` 或資料來源回傳 JSON |
| [ ] 是否有 fallback 機制？ | 無後端或 API 掛掉時，是否有靜態資料或友善錯誤訊息 |

### 7.4 適用場景對照

| 生產環境 | API 來源 | 建議作法 |
|----------|----------|----------|
| 純靜態（Pages / Vercel / Netlify） | 無後端 | 使用靜態 JSON、或建置時寫入資料 |
| 純靜態 | 外接後端（Zeabur、自架） | 設定 `VITE_API_URL`，並確保後端 CORS 允許前端網域 |
| SSR（Next、Nuxt 等） | 同主機 API | 同網域 `/api` 可行，但仍建議用環境變數管理 |
