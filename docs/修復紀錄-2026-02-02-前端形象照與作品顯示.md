# 修復紀錄｜前端形象照與作品顯示（2026-02-02）

## 〇、問題發生時機

| 階段 | 狀況 |
|------|------|
| 後台（admin-full.html） | 已上傳 Daniel 形象照與作品，Supabase 資料庫有正確資料 |
| 前端（成員牆） | 看不到形象照，也看不到上傳的作品 |
| 核對 | `npm run verify:supabase` 顯示後端資料正確（Daniel 有 avatar、1 筆作品） |

**結論**：後端 Supabase 與圖片 URL 皆正常，問題出在前端**未從 Supabase 讀取資料**，或讀取後未正確顯示圖片。

---

## 一、現象

- 後台能看到 Daniel 的形象照片與作品。
- 前端成員牆：Daniel 卡片沒有形象照（只顯示姓名縮寫）、詳情內沒有作品。
- 部分情境下 Network 看不到對 Supabase 的請求（「沒有請求」）。

---

## 二、原因分析

### 2.1 資料來源邏輯

前端 `fetchMembers()` 的資料來源由兩者決定：

1. **是否使用 Supabase**：依 `VITE_SUPABASE_URL` 與 `supabase` client 是否存在。
2. **未使用 Supabase 時**：改為 `fetch(apiUrl("api/members"))`；生產環境且未設 `VITE_API_URL` 時會讀取靜態 `/members.json`。

### 2.2 問題根因

1. **建置／執行時未設定 Supabase 環境變數**  
   若 `VITE_SUPABASE_URL`、`VITE_SUPABASE_PUBLISHABLE_KEY` 未在建置或執行時注入，前端會走「非 Supabase」路徑，改讀 `/members.json`。而 `public/members.json` **沒有** `avatar` 欄位、`portfolio` 為空陣列，因此畫面上沒有形象照與作品。

2. **無 Supabase 請求**  
   未走 Supabase 時不會對 Supabase REST API 發請求，Network 中看不到 `hua_members` / `hua_member_portfolios` 的請求。

3. **依賴 supabase-js client 的請求方式**  
   曾使用 `supabase.from().select()`，在部分環境下請求行為較不直觀，除錯時不易確認是否有發出請求。

---

## 三、修復方式

### 3.1 解決方案概覽

1. **Supabase 預設連線**：與後台 admin-full.html 同專案，在前端加入 Supabase URL 與 anon key 的 **fallback**，未設 env 時仍連到同一 Supabase 專案，確保會從 Supabase 讀取成員與作品。
2. **改為顯式 fetch 呼叫 Supabase REST API**：成員資料改為用原生 `fetch()` 直接呼叫 Supabase REST（`/rest/v1/hua_members`、`/rest/v1/hua_member_portfolios`），讓 Network 一定會出現這兩筆請求，方便核對與除錯。
3. **形象照／作品圖 URL**：前端 `portfolioImageUrl()` 在「有 Supabase URL」時，對相對路徑組出 Supabase Storage 公開 URL；對完整 URL 則確保含 `/object/public/`，避免 504／403。
4. **錯誤處理與除錯**：作品表請求失敗時改為使用空陣列，避免整包載入失敗；開發模式在 console 輸出載入結果摘要（成員數、有形象照／作品的人數）。

### 3.2 修改檔案與內容

| 檔案 | 變更 |
|------|------|
| `src/integrations/supabase/client.ts` | 新增 Supabase URL、anon key 的 fallback（與後台同專案）；匯出 `SUPABASE_URL`、`SUPABASE_PUBLISHABLE_KEY` 供 members API 使用。 |
| `src/api/members.ts` | 改為依 `BASE`（Supabase URL）決定是否走 Supabase；使用 `fetch()` 直接呼叫 `/rest/v1/hua_members`、`/rest/v1/hua_member_portfolios`；作品表非 200 時使用空陣列；DEV 時 log 載入摘要。 |
| `src/api/images.ts` | Supabase URL 改為含 fallback，確保未設 env 時仍能正確組出 Supabase Storage 公開圖片 URL。 |
| `src/components/members/MemberDetailDialog.tsx` | `DialogContent` 加上 `aria-describedby={undefined}`，消除無障礙警告。 |
| `src/components/ui/command.tsx` | 同上。 |
| `scripts/verify-supabase-sync.mjs` | 新增前後端 Supabase 同步驗證腳本。 |
| `package.json` | 新增 `verify:supabase` script。 |
| `docs/SUPABASE-VERIFY.md` | 補充前後端同步驗證說明與欄位對應。 |

### 3.3 修復後邏輯

```
前端載入成員牆
  → fetchMembers() 有 BASE（Supabase URL，含 fallback）
  → fetchFromSupabase()：兩筆 fetch 到 Supabase REST API
      - GET .../rest/v1/hua_members?select=*&order=no.asc
      - GET .../rest/v1/hua_member_portfolios?select=*&order=sort_order.asc
  → 合併為 Member[]，含 avatar、portfolio
  → portfolioImageUrl(avatar) / portfolioImageUrl(item.image) 產出正確圖片 URL
  → 卡片與詳情顯示形象照與作品
```

### 3.4 驗證方式

- **後端與 DB 一致**：執行 `npm run verify:supabase`，確認成員數、形象照有無、作品數與 Supabase 一致。
- **前端有請求**：F12 → Network，重新整理首頁，應看到對 `hua_members`、`hua_member_portfolios` 的請求。
- **開發模式**：Console 應出現 `[fetchMembers] Supabase 已載入 X 位成員，有形象照: Y 位，有作品: Z 位`。

---

## 四、後續注意

1. **部署時**：若希望前端一定從 Supabase 讀取，建置／部署環境可設定 `VITE_SUPABASE_URL`、`VITE_SUPABASE_PUBLISHABLE_KEY`；未設定時會使用程式內 fallback（與後台同專案）。
2. **前後端同步**：前端與後台（admin-full.html）需使用**同一組** Supabase URL 與 anon key，形象照與作品才會一致。
3. **圖片 URL**：後台寫入的 `avatar`、作品 `image` 應為 Supabase Storage 公開 URL（含 `/object/public/`）；前端會對舊格式自動補正。

---

## 五、相關文件

- `docs/SUPABASE-VERIFY.md`：Supabase 整合與前後端同步驗證
- `docs/前後台照片同步驗證.md`：照片同步流程與必要條件
