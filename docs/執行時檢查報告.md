# 執行時檢查報告（無限循環／空值／邊界）

## 已修復項目

### 1. 空值導致錯誤

| 位置 | 問題 | 修復 |
|------|------|------|
| **src/api/images.ts** | `portfolioImageUrl("")` 或 `null` 會變成 `apiUrl("/")`，可能請求無效 URL或破圖 | 開頭加上 `image == null`、`typeof image !== "string"`、`trim() === ""` 時直接回傳 `""` |
| **backend/src/routes/members.js** | `memberService.list()` 若回傳 `undefined`，`sortByNo(members)` 會因 `members.slice()` 報錯 | 改為 `sortByNo(Array.isArray(members) ? members : [])` |
| **public/admin-full.html** | 成員列若含 `no == null`，會出現 `byNo[undefined]`，排序與顯示異常 | GET 成員／members-only 與 load() 中過濾 `r.no != null`、`m && m.no != null`，並以 `Array.isArray(membersOnly) ? ... : []` 防非陣列 |
| **src/api/members.ts** | Supabase 回傳列若含 `no == null`，會進 `byNo` 造成異常 | 使用 `(membersRes.data ?? []).filter((r: any) => r?.no != null)` 再組 byNo |

### 2. 無限循環檢查結果：未發現

- **React useEffect**：Index 的 effect 依賴 `[members, searchParams]`，只讀取並 `setSelectedMember`／`setDetailOpen`，未改動 `members` 或 `searchParams`，不會造成循環。
- **useMembers**：effect 依賴 `[toast]`；若 `useToast()` 回傳穩定參考則只會跑一次。若父層每次傳入新的 toast 參考，會造成重複 fetch，但每次 fetch 完成後只 setState，不會無限循環，僅可能多打幾次 API。
- **admin-full.html**：`load()` 為一次性 async，無 `while`／`setInterval`；成功後只更新 DOM 與 cache，不會再次自動觸發 load。
- **setTimeout(() => load(true), …)**：僅在新增／編輯／刪除成功後延遲呼叫一次，無循環。

---

## 建議注意（未改程式）

| 項目 | 說明 |
|------|------|
| **useMembers 的 toast 依賴** | `useEffect(..., [toast])` 若父層傳入的 `toast` 每次 render 都換參考，會重複請求成員。可考慮用 `useRef(toast)` 或依賴改為 `[]`（僅掛載時取一次），依產品需求取捨。 |
| **sessionStorage 滿** | 管理後台快取寫入 `sessionStorage`，若使用者關閉或配額滿可能 `setItem` 拋錯；目前外層已有 `try/catch`，僅略過寫入，不影響流程。 |

---

## 小結

- **無限循環**：未發現；所有 async／effect／setTimeout 均有明確結束條件或單次觸發。
- **空值／邊界**：已對 `portfolioImageUrl`、後端 list、前後台成員列 `no`、管理後台 membersOnly 做防呆與過濾，避免空值或無效 `no` 導致錯誤或異常顯示。
